<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barangay eBlotter: 5D Cyber-Reporting System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- CryptoJS for Blockchain Hashing and Evidence Integrity -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        /* Custom Styles for 5D Dark Mode / Cyberpunk UI */
        :root {
            --primary-color: #6a0dad; /* Deep Purple */
            --secondary-color: #00bcd4; /* Cyan/Aqua */
            --background-color: #0D0D2B; /* Dark Space Blue */
            --glow-color-1: #6a0dad; /* Purple */
            --glow-color-2: #00bcd4; /* Cyan */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: #f8fafc; /* Slate 50 */
            min-height: 100vh;
            background-image: radial-gradient(circle at center, rgba(106, 13, 173, 0.05) 0%, rgba(13, 13, 43, 1) 70%);
        }

        /* 5D Glowing Card Effect */
        .glass {
            background-color: rgba(18, 18, 50, 0.8); /* Darker transparent blue */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(106, 13, 173, 0.3); /* Purple border for structure */
            border-radius: 1.5rem; /* More rounded */
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.3), 0 0 10px rgba(106, 13, 173, 0.6); /* Cyan and Purple Glow */
            transition: all 0.4s ease-in-out;
        }

        .glass:hover {
            box-shadow: 0 0 30px rgba(0, 188, 212, 0.5), 0 0 15px rgba(106, 13, 173, 0.8);
        }

        /* Input Field Focus */
        .input-field {
            background-color: #1a1a40; /* Very dark input background */
            border: 1px solid #3d3d6e;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 5px var(--secondary-color);
        }

        /* Primary Button Style (Cyber Button) */
        .btn-primary {
            background: linear-gradient(90deg, #6a0dad, #00bcd4);
            transition: all 0.3s ease-in-out;
            color: white;
            font-weight: 600;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #00bcd4, #6a0dad);
            box-shadow: 0 0 15px #00bcd4;
        }

        /* Danger Button Style (Red Alert) */
        .btn-danger {
            background: linear-gradient(90deg, #991b1b, #ef4444);
            transition: all 0.3s ease-in-out;
            color: white;
            font-weight: 600;
        }
        .btn-danger:hover {
            background: linear-gradient(90deg, #ef4444, #991b1b);
            box-shadow: 0 0 15px #ef4444;
        }

        /* Chatbot toggle glow */
        #chatbot-toggle {
            box-shadow: 0 0 18px rgba(0, 188, 212, 1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #0097a7; }

        /* Timeline Style */
        .timeline {
            border-left: 2px solid rgba(106, 13, 173, 0.5);
        }
        .timeline-item {
            position: relative;
            padding-left: 20px;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -7px; /* Align with border-left of .timeline */
            top: 5px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--secondary-color);
            border: 3px solid var(--background-color);
        }

        /* Waveform Animation for Voice Input */
        @keyframes waveform-pulse {
            0% { transform: scaleY(0.5); opacity: 0.5; }
            50% { transform: scaleY(1.0); opacity: 1.0; }
            100% { transform: scaleY(0.5); opacity: 0.5; }
        }
        .waveform > div {
            animation: waveform-pulse 1s infinite ease-in-out alternate;
            margin: 0 1px;
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Main Application Container -->
    <div id="app" class="relative z-10 w-full max-w-8xl mx-auto min-h-screen">

        <!-- Header -->
        <header class="w-full mb-8 p-6 glass flex flex-col sm:flex-row justify-between items-center rounded-[1.5rem] border-b-4 border-b-purple-500/50">
            <h1 class="text-3xl font-extrabold text-white mb-2 sm:mb-0">Barangay <span class="text-cyan-400">eBlotter</span> System <span class="text-xs text-purple-400">| 5D Core</span></h1>
            <div id="user-actions" class="flex items-center space-x-3 text-sm mt-2 sm:mt-0">
                <span id="user-role" class="px-3 py-1 bg-pink-700/50 rounded-full text-xs font-semibold shadow-md shadow-pink-500/50">Loading...</span>
                <span id="user-id-display" class="font-mono text-xs text-yellow-400 border border-yellow-400/50 p-1 rounded-md">ID: ...</span>
                <button onclick="logoutUser()" class="btn-danger text-xs px-3 py-1 rounded-lg">
                    LOGOUT
                </button>
            </div>
        </header>

        <!-- Dynamic Content Area -->
        <main id="main-content" class="w-full flex-grow">

            <!-- Global Message/Loading Indicator (Neon Style) -->
            <div id="global-message" class="hidden fixed top-4 right-4 z-[100] p-3 px-6 rounded-lg text-sm bg-purple-700/90 shadow-2xl shadow-cyan-400/50 transition-all duration-500 transform translate-x-full border border-cyan-400/50"></div>

            <!-- Loading Screen (Futuristic) -->
            <div id="loading-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/95 z-50 rounded-xl">
                <svg class="animate-spin -ml-1 mr-3 h-12 w-12 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-xl text-purple-400 font-semibold">Initiating 5D Core Systems...</p>
                <p class="text-sm text-gray-500">Securing Blockchain Connection & Loading AI Modules...</p>
            </div>

            <!-- Role Selection (Initial Setup) -->
            <div id="role-select-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-gray-900/95 z-40 p-8 rounded-xl">
                <h2 class="text-4xl font-bold mb-6 text-cyan-400">Access Identity Setup</h2>
                <p class="text-lg mb-8 text-center text-gray-300">Choose your role to establish system access permissions.</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-3xl">
                    <button onclick="setRole('Resident')" class="glass p-6 text-center text-xl font-semibold bg-purple-900/30 hover:bg-purple-800/50 border-cyan-400/50 border rounded-xl">
                        <span class="text-cyan-300">Resident</span> (Report & Track)
                    </button>
                    <button onclick="setRole('Officer')" class="glass p-6 text-center text-xl font-semibold bg-purple-900/30 hover:bg-purple-800/50 border-cyan-400/50 border rounded-xl">
                        <span class="text-cyan-300">Officer</span> (Case Management)
                    </button>
                    <button onclick="setRole('Admin')" class="glass p-6 text-center text-xl font-semibold bg-purple-900/30 hover:bg-purple-800/50 border-cyan-400/50 border rounded-xl">
                        <span class="text-cyan-300">Admin</span> (Full Control)
                    </button>
                </div>
            </div>

            <!-- Dashboard/Navigation -->
            <div id="dashboard-container" class="hidden">
                <!-- Navigation Tabs (Styled to be "Chips") -->
                <nav class="mb-8 flex flex-wrap gap-3 justify-start">
                    <button onclick="changePage('Dashboard')" id="nav-Dashboard" class="px-5 py-2 rounded-full text-sm md:text-base font-semibold transition duration-300 bg-gray-800/50 hover:bg-purple-800/70 border-2 border-transparent text-cyan-300 active-nav-chip">Dashboard</button>
                    <button onclick="changePage('Reporting')" id="nav-Reporting" class="px-5 py-2 rounded-full text-sm md:text-base font-semibold transition duration-300 bg-gray-800/50 hover:bg-purple-800/70 border-2 border-transparent text-cyan-300">File Report</button>
                    <button onclick="changePage('Management')" id="nav-Management" class="px-5 py-2 rounded-full text-sm md:text-base font-semibold transition duration-300 bg-gray-800/50 hover:bg-purple-800/70 border-2 border-transparent text-cyan-300">Case Management</button>
                    <button onclick="changePage('Analytics')" id="nav-Analytics" class="px-5 py-2 rounded-full text-sm md:text-base font-semibold transition duration-300 bg-gray-800/50 hover:bg-purple-800/70 border-2 border-transparent text-cyan-300 hidden">Predictive Analytics</button>
                    <button onclick="changePage('Audit')" id="nav-Audit" class="px-5 py-2 rounded-full text-sm md:text-base font-semibold transition duration-300 bg-gray-800/50 hover:bg-purple-800/70 border-2 border-transparent text-cyan-300 hidden">Audit Trail</button>
                </nav>

                <!-- Page Content -->
                <div id="page-content" class="min-h-[60vh] p-4 md:p-8 glass transition-all duration-500 rounded-[1.5rem]">
                    <!-- Dynamic Page Content will be loaded here -->
                    <p class="text-gray-400 text-center">Loading content...</p>
                </div>
            </div>
        </main>
        
        <!-- Footer / Copyright -->
        <footer class="w-full mt-10 p-4 text-center text-xs glass rounded-[1.5rem] border-t-2 border-purple-500/50">
            <p class="text-gray-400">Barangay eBlotter 5D Core System</p>
            <p class="text-cyan-400 font-semibold">© 2025 Noel Timario. All Rights Reserved.</p>
        </footer>

        <!-- Chatbot Bubble -->
        <div id="chatbot-container" class="fixed bottom-6 right-6 z-30">
            <button id="chatbot-toggle" onclick="toggleChatbot()" class="w-16 h-16 bg-purple-700/80 rounded-full flex items-center justify-center shadow-lg hover:shadow-cyan-400/80 transition duration-300 relative" style="box-shadow: 0 0 20px rgba(0, 188, 212, 0.7);">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot text-white"><path d="M12 8V12V16"/><path d="M11 2h2"/><path d="M12 21a2 2 0 1 0 0 4 2 2 0 1 0 0-4z"/><path d="M10 8c0-2.2 1.8-4 4-4s4 1.8 4 4v4h-8v-4z"/><path d="M5 19c-1.7 0-3-1.3-3-3v-5c0-1.7 1.3-3 3-3h14c1.7 0 3 1.3 3 3v5c0 1.7-1.3 3-3 3H5z"/></svg>
            </button>

            <!-- Chatbot Window (5D Style) -->
            <div id="chatbot-window" class="hidden absolute bottom-20 right-0 w-80 h-96 glass flex flex-col rounded-xl overflow-hidden shadow-2xl border-2 border-cyan-400/30">
                <!-- Chat Header -->
                <div class="p-3 bg-purple-900/80 flex justify-between items-center border-b border-cyan-400/50">
                    <span class="font-bold text-lg text-cyan-400">Barangay eBot</span>
                    <button onclick="toggleChatbot()" class="text-gray-300 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <!-- Chat Messages -->
                <div id="chatbot-messages" class="flex-grow p-3 overflow-y-auto space-y-3 custom-scrollbar bg-transparent">
                    <div class="flex justify-start">
                        <div class="bg-cyan-600/30 p-2 rounded-lg max-w-[80%] shadow-md shadow-cyan-400/20">
                            <p class="text-sm">Kumusta, I am **Barangay Bot**, your AI-Powered guide. I can help you submit a complaint, track a case, or answer local law FAQs. How may I assist you?</p>
                        </div>
                    </div>
                </div>
                <!-- Chat Input (Glow) -->
                <div class="p-3 border-t border-purple-400/50 flex items-center bg-gray-900/80">
                    <input type="text" id="chat-input" placeholder="Message Barangay Bot (English/Tagalog)..." class="flex-grow p-2 rounded-l-lg bg-gray-900 border border-purple-700/50 input-field text-sm text-white" onkeydown="if(event.key === 'Enter') sendChatMessage()">
                    <!-- Voice Button is for demonstration as TTS/STT are complex to implement directly here -->
                    <!-- <button id="voice-input-btn" onclick="toggleVoiceInput()" class="p-2 bg-green-500/80 hover:bg-green-400/80 transition duration-200 shadow-lg shadow-green-500/50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic text-white">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="23"/><line x1="8" x2="16" y1="23" y2="23"/>
                        </svg>
                    </button> -->
                    <!-- Send Button (Neon Purple/Cyan) -->
                    <button onclick="sendChatMessage()" class="p-2 btn-primary rounded-r-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send text-white">
                            <path d="m22 2-7 20-4-9-9-4 20-7z"/><path d="M15 11l-4 4"/>
                        </svg>
                    </button>
                </div>
                    <!-- Waveform Indicator -->
                <div id="voice-waveform" class="hidden h-5 flex items-end justify-center py-1 bg-gray-900/50 waveform">
                    <div class="h-4 w-1 rounded-full bg-cyan-400" style="animation-delay: -1s;"></div>
                    <div class="h-3 w-1 rounded-full bg-cyan-400" style="animation-delay: -0.5s;"></div>
                    <div class="h-5 w-1 rounded-full bg-cyan-400" style="animation-delay: -0.7s;"></div>
                    <div class="h-2 w-1 rounded-full bg-cyan-400" style="animation-delay: -0.3s;"></div>
                    <div class="h-4 w-1 rounded-full bg-cyan-400" style="animation-delay: -0.6s;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Evidence Preview/Case View -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md transition-opacity duration-300" onclick="closeModal(event)">
        <div id="modal-content" class="glass p-6 w-full max-w-lg rounded-[1.5rem] shadow-2xl shadow-purple-500/50 transition-transform duration-300 scale-95 border border-cyan-400/50" onclick="event.stopPropagation()">
            <!-- Modal Content Loaded Here -->
        </div>
    </div>

    <!-- Firebase & Custom Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-eblotter-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const API_KEY = ""; // Gemini API Key (empty string for Canvas environment)

        // --- GLOBAL STATE ---
        window.app = null;
        window.db = null;
        window.auth = null;
        window.USER_ID = null;
        window.USER_ROLE = 'Resident'; // Default role
        window.COMPLAINTS_DATA = [];
        window.CURRENT_PAGE = 'Dashboard';
        window.CASE_ID_COUNTER = 1000;
        window.CHATBOT_HISTORY = [];
        window.isChatbotOpen = false;

        // --- UTILITIES ---

        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        window.generateBlockHash = (data) => {
            const dataString = JSON.stringify(data);
            return CryptoJS.SHA256(dataString).toString(CryptoJS.enc.Hex);
        };

        window.showTemporaryMessage = (message, type = 'success', duration = 3000) => {
            const msgBox = document.getElementById('global-message');
            const bgColor = type === 'error' ? 'bg-red-700/90 shadow-red-500/50 border-red-400/50' : (type === 'info' ? 'bg-cyan-700/90 shadow-cyan-400/50 border-cyan-400/50' : 'bg-green-700/90 shadow-green-400/50 border-green-400/50');
            const shadow = type === 'error' ? 'shadow-red-500/50' : (type === 'info' ? 'shadow-cyan-400/50' : 'shadow-green-400/50');

            msgBox.className = `fixed top-4 right-4 z-[100] p-3 px-6 rounded-lg text-sm transition-all duration-500 transform text-white ${bgColor} shadow-2xl ${shadow}`;
            msgBox.innerHTML = message; // Use innerHTML to allow for bold/formatted text
            msgBox.classList.remove('hidden', 'translate-x-full');

            setTimeout(() => {
                msgBox.classList.add('translate-x-full');
            }, duration);
        };

        const generateMockAnalytics = (data) => {
            const counts = data.reduce((acc, c) => {
                acc.type[c.ai.category] = (acc.type[c.ai.category] || 0) + 1;
                acc.status[c.status] = (acc.status[c.status] || 0) + 1;
                acc.urgency[c.ai.urgency] = (acc.urgency[c.ai.urgency] || 0) + 1;
                return acc;
            }, { type: {}, status: {}, urgency: {} });

            const resolvedCases = data.filter(c => c.status === 'Resolved' || c.status === 'Closed').length;
            const avgResolutionTime = data.length > 5 ? (Math.floor(Math.random() * 10) + 5) + ' days' : 'N/A';

            return { counts, resolvedCases, avgResolutionTime, totalHashed: data.length };
        };

        window.openModal = (contentHtml, title) => {
            document.getElementById('modal-content').innerHTML = `
                <div class="flex justify-between items-center pb-4 border-b border-purple-500/50 mb-4">
                    <h3 class="text-xl font-bold text-cyan-400">${title}</h3>
                    <button onclick="closeModal()" class="text-gray-300 hover:text-white text-3xl">&times;</button>
                </div>
                ${contentHtml}
            `;
            document.getElementById('modal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('modal-content').classList.remove('scale-95');
                document.getElementById('modal-content').classList.add('scale-100');
            }, 10);
        };

        // Function defined for HTML call (onclick="closeModal(event)")
        window.closeModal = (event) => {
            // Check if the click was directly on the background (modal container) or the close button
            if (event && event.target !== document.getElementById('modal')) return;

            document.getElementById('modal-content').classList.remove('scale-100');
            document.getElementById('modal-content').classList.add('scale-95');
            setTimeout(() => {
                document.getElementById('modal').classList.add('hidden');
            }, 300);
        };

        // --- GEMINI AI PROCESSING FOR INCIDENTS ---

        const processComplaintNarrative = async (narrative) => {
            window.showTemporaryMessage("AI Processing: Analyzing narrative for categorization and urgency...", 'info');

            const XAI_JUSTIFICATION = "AI analysis performed using Gemini 2.5-Flash NLP Core. Location data (if provided) is cross-referenced with historical patterns (simulated).";

            const systemPrompt = `You are a sophisticated NLP model for the Philippine eBlotter system. Your task is to analyze the provided incident narrative and return a highly structured, accurate JSON response. You must categorize the case, summarize it (max 50 words), and determine the urgency and sentiment. Respond ONLY with the requested JSON structure. Categories: Noise, Dispute, Theft, Vandalism, PublicSafety, Domestic, Other. Urgency: Critical, High, Medium, Low. Sentiment: Angry, Distressed, Neutral, Calm.`;

            const userQuery = `Analyze this incident narrative for categorization, summary, urgency, and sentiment: "${narrative}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            category: { type: "STRING" },
                            summary: { type: "STRING" },
                            urgency: { type: "STRING" },
                            sentiment: { type: "STRING" }
                        },
                        required: ["category", "summary", "urgency", "sentiment"]
                    }
                },
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    const aiData = JSON.parse(jsonText);
                    window.showTemporaryMessage("AI Analysis Complete: Case categorized.", 'success');
                    return { ...aiData, xai_justification: XAI_JUSTIFICATION };
                } else {
                    throw new Error("AI returned an invalid or empty response.");
                }
            } catch (error) {
                console.error("AI Processing Error:", error);
                window.showTemporaryMessage("AI Error: Could not process narrative. Defaulting values.", 'error');
                // Return defaults on failure
                return {
                    category: 'Other',
                    summary: 'AI processing failed for this case.',
                    urgency: 'Medium',
                    sentiment: 'Neutral',
                    xai_justification: 'AI analysis failed to provide a justification.',
                };
            }
        };


        // --- FIREBASE INITIALIZATION & DATA LISTENER ---

        window.initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. App cannot run.");
                return;
            }

            try {
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);

                // Use onAuthStateChanged to handle initial token and subsequent state changes
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.USER_ID = user.uid;
                        document.getElementById('user-id-display').textContent = 'ID: ' + window.USER_ID.substring(0, 8) + '...';
                        initializeRoleAndData();
                    } else {
                        // Attempt silent sign-in if initial token exists
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                            } catch (e) {
                                console.log("Custom token sign-in failed, signing in anonymously:", e);
                                await signInAnonymously(window.auth);
                            }
                        } else {
                            // Anonymous sign-in if no token
                            await signInAnonymously(window.auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-screen').classList.add('hidden');
                window.showTemporaryMessage("SYSTEM FAILURE: Firebase connection failed.", 'error');
            }
        };

        const initializeRoleAndData = async () => {
            const profileRef = doc(window.db, `artifacts/${appId}/users/${window.USER_ID}/profile`, 'role');
            try {
                const profileSnap = await getDoc(profileRef);
                if (profileSnap.exists() && profileSnap.data().role) {
                    window.USER_ROLE = profileSnap.data().role;
                    setupApplication();
                } else {
                    // Role not set yet, prompt the user
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('role-select-screen').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error reading user role:", error);
                window.USER_ROLE = 'Resident'; // Default to Resident on read error
                setupApplication();
            }
        };

        window.setRole = async (role) => {
            const profileRef = doc(window.db, `artifacts/${appId}/users/${window.USER_ID}/profile`, 'role');
            try {
                await setDoc(profileRef, { role: role, userId: window.USER_ID });
                window.USER_ROLE = role;
                document.getElementById('role-select-screen').classList.add('hidden');
                setupApplication();
            } catch (error) {
                console.error("Error setting user role:", error);
            }
        };

        window.logoutUser = async () => {
            window.showTemporaryMessage("Terminating session... Resetting core access.", 'info');

            // Sign out
            if (window.auth) {
                await signOut(window.auth).catch(e => console.error("Sign out error:", e));
            }

            // Reload the app state to re-run the initialization and prompt for role selection
            // Using a simple reload or showing the role screen manually after clearing state
            window.USER_ROLE = 'Resident';
            window.COMPLAINTS_DATA = [];
            window.CHATBOT_HISTORY = [];
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('role-select-screen').classList.remove('hidden');
            document.getElementById('user-role').textContent = 'Logged Out';

            window.showTemporaryMessage("Session Terminated. Please select a new role to re-access the Cyber-Core.", 'info', 5000);
        };


        const setupApplication = () => {
            document.getElementById('user-role').textContent = window.USER_ROLE;

            // Update Nav visibility based on role
            const isAdminOrOfficer = ['Admin', 'Officer'].includes(window.USER_ROLE);
            document.getElementById('nav-Analytics').classList.toggle('hidden', !isAdminOrOfficer);
            document.getElementById('nav-Audit').classList.toggle('hidden', !isAdminOrOfficer);
            document.getElementById('nav-Management').classList.toggle('hidden', window.USER_ROLE === 'Resident');

            setupDataListener();

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
            window.changePage(window.CURRENT_PAGE);
        };

        const setupDataListener = () => {
            const incidentsRef = collection(window.db, `artifacts/${appId}/public/data/incidents`);
            const q = query(incidentsRef);

            onSnapshot(q, (snapshot) => {
                const incidents = [];
                let maxCaseId = window.CASE_ID_COUNTER;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    incidents.push({ id: doc.id, ...data });
                    if (data.caseId && data.caseId > maxCaseId) {
                        maxCaseId = data.caseId;
                    }
                });

                window.COMPLAINTS_DATA = incidents.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                window.CASE_ID_COUNTER = maxCaseId + 1;

                // Re-render the current page to update data
                window.changePage(window.CURRENT_PAGE, false); // Don't log page change
            }, (error) => {
                console.error("Error listening to data:", error);
                window.showTemporaryMessage("Data Stream Interruption. Cannot fetch real-time blotter data.", 'error');
            });
        };

        // --- CRUD OPERATIONS ---

        window.saveIncident = async (formData, docId = null) => {
            if (!window.db || !window.USER_ID) return console.error("Database or User ID not ready.");
            const incidentsRef = collection(window.db, `artifacts/${appId}/public/data/incidents`);

            let actionType = docId ? 'UPDATE' : 'CREATE';
            let data = { ...formData, updatedAt: new Date().toISOString() };
            let caseId = formData.caseId;

            try {
                if (actionType === 'CREATE') {
                    // 1. AI Processing for new case
                    const aiResults = await processComplaintNarrative(data.narrative);
                    data.ai = aiResults;

                    // 2. Set creation fields
                    caseId = window.CASE_ID_COUNTER;
                    data.caseId = caseId;
                    data.createdAt = new Date().toISOString();
                    data.status = 'Filed';
                    data.reportingUserId = window.USER_ID;

                    // 3. Generate initial Blockchain Hash
                    const dataForHash = { ...data, auditLog: [] };
                    const auditData = {
                        action: actionType,
                        caseId,
                        userId: window.USER_ID,
                        dataHash: window.generateBlockHash(dataForHash),
                        timestamp: data.createdAt,
                        previousHash: '0'
                    };
                    auditData.hash = window.generateBlockHash(auditData);
                    data.auditLog = [auditData];

                    const docRef = doc(incidentsRef);
                    await setDoc(docRef, data);

                    const reportId = data.isAnonymous ? docRef.id : caseId;
                    const message = data.isAnonymous
                        ? `**ANONYMOUS REPORT FILED!** Use Temp ID: **${docRef.id}** to track your case.`
                        : `Case ID **${caseId}** filed and Verified on Blockchain ✅`;

                    window.showTemporaryMessage(message, 'success', 8000);
                    window.changePage('Dashboard'); // Go back to dashboard after filing

                } else { // UPDATE (Case Management logic)
                    if (!['Admin', 'Officer'].includes(window.USER_ROLE)) {
                        window.showTemporaryMessage("ACCESS DENIED: Insufficient Security Clearance for Case Modification.", 'error');
                        return;
                    }

                    const docRef = doc(incidentsRef, docId);
                    const oldData = window.COMPLAINTS_DATA.find(c => c.id === docId);

                    if (!oldData) {
                        window.showTemporaryMessage("Error: Case not found for update.", 'error');
                        return;
                    }

                    // Prepare data for hashing (excluding audit log for hash calculation)
                    const dataForHash = { ...data, auditLog: [] }; // Exclude audit log for base data hashing

                    const newAuditEntry = {
                        action: actionType,
                        caseId: caseId,
                        userId: window.USER_ID,
                        timestamp: data.updatedAt,
                        previousHash: oldData.auditLog[oldData.auditLog.length - 1].hash
                    };

                    newAuditEntry.dataHash = window.generateBlockHash(dataForHash);
                    newAuditEntry.hash = window.generateBlockHash(newAuditEntry);

                    // Update the document
                    await updateDoc(docRef, {
                        ...data,
                        auditLog: [...oldData.auditLog, newAuditEntry]
                    });

                    window.showTemporaryMessage(`Case ID ${caseId} updated. New block hashed to Audit Trail ✅`, 'success');
                    window.changePage('Management');
                }
            } catch (error) {
                console.error("Error saving incident:", error);
                window.showTemporaryMessage(`ERROR: Data Transfer Failed. See console.`, 'error');
            }
        };

        window.updateCaseStatus = async (docId, newStatus) => {
            if (!['Admin', 'Officer'].includes(window.USER_ROLE)) {
                window.showTemporaryMessage("ACCESS DENIED: Officer/Admin privileges required for status change.", 'error');
                return;
            }

            const incidentsRef = collection(window.db, `artifacts/${appId}/public/data/incidents`);
            const docRef = doc(incidentsRef, docId);
            const oldData = window.COMPLAINTS_DATA.find(c => c.id === docId);

            if (!oldData) {
                window.showTemporaryMessage("Error: Case not found.", 'error');
                return;
            }

            const updatedData = {
                ...oldData,
                status: newStatus,
                updatedAt: new Date().toISOString()
            };

            // Prepare data for new audit entry
            const dataForHash = { ...updatedData, auditLog: [] }; // Exclude audit log for base data hashing

            const newAuditEntry = {
                action: `STATUS_CHANGE_TO_${newStatus.toUpperCase()}`,
                caseId: oldData.caseId,
                userId: window.USER_ID,
                timestamp: updatedData.updatedAt,
                previousHash: oldData.auditLog[oldData.auditLog.length - 1].hash
            };

            newAuditEntry.dataHash = window.generateBlockHash(dataForHash);
            newAuditEntry.hash = window.generateBlockHash(newAuditEntry);

            // Update the document
            await updateDoc(docRef, {
                status: newStatus,
                updatedAt: updatedData.updatedAt,
                auditLog: [...oldData.auditLog, newAuditEntry]
            });

            window.showTemporaryMessage(`Case **${oldData.caseId}** status changed to **${newStatus}** and Logged.`, 'info');
        };


        // --- PAGE RENDERING & NAVIGATION ---

        window.changePage = (pageName, shouldLog = true) => {
            window.CURRENT_PAGE = pageName;
            
            // Highlight the active navigation chip
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('border-cyan-400', 'bg-purple-800/70');
                btn.classList.add('border-transparent', 'bg-gray-800/50');
            });
            const activeNav = document.getElementById(`nav-${pageName}`);
            if(activeNav) {
                activeNav.classList.add('border-cyan-400', 'bg-purple-800/70');
                activeNav.classList.remove('bg-gray-800/50');
            }

            const pageContent = document.getElementById('page-content');
            pageContent.innerHTML = '';
            
            switch (pageName) {
                case 'Dashboard':
                    renderDashboard(pageContent);
                    break;
                case 'Reporting':
                    renderReportingForm(pageContent);
                    break;
                case 'Management':
                    if (['Admin', 'Officer'].includes(window.USER_ROLE)) {
                        renderCaseManagement(pageContent);
                    } else {
                        pageContent.innerHTML = `<p class="text-red-400 text-center text-xl p-12">ACCESS DENIED: Requires Officer or Admin Clearance.</p>`;
                    }
                    break;
                case 'Analytics':
                    if (['Admin', 'Officer'].includes(window.USER_ROLE)) {
                        renderAnalytics(pageContent);
                    } else {
                        pageContent.innerHTML = `<p class="text-red-400 text-center text-xl p-12">ACCESS DENIED: Requires Officer or Admin Clearance.</p>`;
                    }
                    break;
                case 'Audit':
                    if (['Admin', 'Officer'].includes(window.USER_ROLE)) {
                        renderAuditTrail(pageContent);
                    } else {
                        pageContent.innerHTML = `<p class="text-red-400 text-center text-xl p-12">ACCESS DENIED: Requires Officer or Admin Clearance.</p>`;
                    }
                    break;
                default:
                    pageContent.innerHTML = `<p class="text-yellow-400 text-center text-xl p-12">System: Page Not Found. Redirecting to Dashboard...</p>`;
                    window.changePage('Dashboard');
            }
        };

        const renderDashboard = (container) => {
            const userCases = window.COMPLAINTS_DATA.filter(c => c.reportingUserId === window.USER_ID || c.isAnonymous);
            
            let html = `
                <h2 class="text-3xl font-bold mb-6 text-cyan-400 border-b border-purple-500/50 pb-2">User Command Center</h2>
                
                <!-- Metrics Panel -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass p-5 rounded-xl shadow-lg shadow-purple-500/30">
                        <p class="text-sm text-gray-400">Total Reports Filed</p>
                        <p class="text-4xl font-extrabold text-cyan-400">${userCases.length}</p>
                    </div>
                    <div class="glass p-5 rounded-xl shadow-lg shadow-purple-500/30">
                        <p class="text-sm text-gray-400">Pending Resolution</p>
                        <p class="text-4xl font-extrabold text-yellow-400">${userCases.filter(c => c.status === 'Filed' || c.status === 'In Progress').length}</p>
                    </div>
                    <div class="glass p-5 rounded-xl shadow-lg shadow-purple-500/30">
                        <p class="text-sm text-gray-400">Resolved Cases</p>
                        <p class="text-4xl font-extrabold text-green-400">${userCases.filter(c => c.status === 'Resolved' || c.status === 'Closed').length}</p>
                    </div>
                </div>

                <h3 class="text-2xl font-semibold mb-4 text-purple-400">Your Filed Reports</h3>
                <div class="space-y-4">
            `;

            if (userCases.length === 0) {
                html += `<p class="text-gray-400 p-8 text-center border border-dashed border-cyan-400/50 rounded-xl">No reports found under your ID. Click 'File Report' to start a new case.</p>`;
            } else {
                userCases.forEach(c => {
                    const statusColor = c.status === 'Resolved' || c.status === 'Closed' ? 'bg-green-600/50' : (c.status === 'Filed' ? 'bg-yellow-600/50' : 'bg-blue-600/50');
                    const caseIdDisplay = c.isAnonymous ? c.id.substring(0, 8) + '...' : c.caseId;

                    html += `
                        <div class="glass p-4 rounded-xl flex flex-col md:flex-row justify-between items-start md:items-center hover:shadow-cyan-400/30">
                            <div>
                                <p class="text-lg font-bold text-cyan-300">Case ID: ${caseIdDisplay} <span class="text-sm text-gray-400">(${c.isAnonymous ? 'Anonymous' : 'Registered'})</span></p>
                                <p class="text-sm text-gray-300">${c.ai?.summary || c.narrative.substring(0, 80) + '...'}</p>
                                <p class="text-xs text-purple-300 mt-1">Filed: ${new Date(c.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="mt-3 md:mt-0 flex items-center space-x-3">
                                <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusColor}">${c.status}</span>
                                <button onclick="viewCase('${c.id}')" class="btn-primary text-xs px-3 py-1 rounded-lg">View Details</button>
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div>`;
            container.innerHTML = html;
        };

        const renderReportingForm = (container) => {
            const isAdmin = window.USER_ROLE === 'Admin';
            container.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-cyan-400 border-b border-purple-500/50 pb-2">File New Incident Report (${window.USER_ROLE})</h2>
                <form id="report-form" class="space-y-4 max-w-2xl mx-auto">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Complainant Name</label>
                        <input type="text" id="complainant" required class="w-full p-3 rounded-lg input-field text-white" value="${isAdmin ? 'Admin User' : 'Registered User'}">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Contact / Location (Zone/Purok)</label>
                        <input type="text" id="contact" required class="w-full p-3 rounded-lg input-field text-white" placeholder="Contact number or location details">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Incident Narrative (What happened?)</label>
                        <textarea id="narrative" required class="w-full p-3 rounded-lg input-field text-white h-32" placeholder="Provide a detailed account of the incident. The AI Core will analyze this narrative for urgency and classification."></textarea>
                    </div>
                    <div class="flex items-center space-x-3 pt-2">
                        <input type="checkbox" id="isAnonymous" class="form-checkbox h-5 w-5 text-cyan-500 bg-gray-700 border-gray-600 rounded">
                        <label for="isAnonymous" class="text-sm font-medium text-red-400">File Anonymously (Contact details will be hidden/omitted)</label>
                    </div>
                    <button type="submit" class="w-full p-3 mt-6 btn-primary rounded-xl text-lg hover:shadow-cyan-400">
                        <span class="inline-block transition-transform duration-300 group-hover:scale-105">SUBMIT REPORT TO AI CORE</span>
                    </button>
                </form>
            `;

            document.getElementById('report-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const isAnonymous = document.getElementById('isAnonymous').checked;
                
                const formData = {
                    complainant: isAnonymous ? 'Anonymous Reporter' : document.getElementById('complainant').value.trim(),
                    complainantContact: isAnonymous ? '' : document.getElementById('contact').value.trim(),
                    narrative: document.getElementById('narrative').value.trim(),
                    isAnonymous: isAnonymous
                };
                
                if (formData.narrative.length < 50) {
                    window.showTemporaryMessage("Narrative must be at least 50 characters for AI analysis.", 'error');
                    return;
                }

                await window.saveIncident(formData);
            });
        };

        const renderCaseManagement = (container) => {
            container.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-cyan-400 border-b border-purple-500/50 pb-2">Cyber-Blotter Case Management (${window.COMPLAINTS_DATA.length} Active Cases)</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm rounded-lg overflow-hidden border border-purple-500/50">
                        <thead class="bg-purple-900/50 text-cyan-400">
                            <tr>
                                <th class="p-3 text-left">ID</th>
                                <th class="p-3 text-left">Category</th>
                                <th class="p-3 text-left">Urgency</th>
                                <th class="p-3 text-left">Status</th>
                                <th class="p-3 text-left">Filer</th>
                                <th class="p-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="case-table-body" class="divide-y divide-purple-700/50">
                        </tbody>
                    </table>
                </div>
            `;

            const tbody = document.getElementById('case-table-body');
            window.COMPLAINTS_DATA.forEach(c => {
                const urgencyColor = c.ai.urgency === 'Critical' ? 'bg-red-700/50' : (c.ai.urgency === 'High' ? 'bg-orange-700/50' : 'bg-yellow-700/50');
                const statusColor = c.status === 'Resolved' || c.status === 'Closed' ? 'bg-green-600/50' : (c.status === 'Filed' ? 'bg-yellow-600/50' : 'bg-blue-600/50');
                const filerDisplay = c.isAnonymous ? 'Anonymous' : c.complainant.substring(0, 15);

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-800/50 transition duration-150';
                row.innerHTML = `
                    <td class="p-3 font-mono text-xs text-cyan-300">${c.caseId}</td>
                    <td class="p-3">${c.ai.category}</td>
                    <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-semibold ${urgencyColor}">${c.ai.urgency}</span></td>
                    <td class="p-3"><span id="status-${c.id}" class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${c.status}</span></td>
                    <td class="p-3 text-gray-400">${filerDisplay}</td>
                    <td class="p-3 flex space-x-2 justify-center">
                        <button onclick="viewCase('${c.id}')" class="btn-primary text-xs px-2 py-1 rounded-lg">View</button>
                        <select onchange="updateCaseStatus('${c.id}', this.value)" class="p-1 rounded-lg bg-gray-900 border border-purple-700/50 input-field text-xs text-white">
                            <option value="" disabled selected>Change Status</option>
                            <option value="Filed">Filed</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Mediated">Mediated</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        const renderAnalytics = (container) => {
            const stats = generateMockAnalytics(window.COMPLAINTS_DATA);

            container.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-cyan-400 border-b border-purple-500/50 pb-2">Predictive Analytics & System Metrics</h2>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8 text-center">
                    <div class="glass p-4 rounded-xl">
                        <p class="text-sm text-gray-400">Total Records Hashed</p>
                        <p class="text-3xl font-extrabold text-cyan-400">${stats.totalHashed}</p>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <p class="text-sm text-gray-400">Resolved Percentage</p>
                        <p class="text-3xl font-extrabold text-green-400">${stats.totalHashed > 0 ? ((stats.resolvedCases / stats.totalHashed) * 100).toFixed(1) : 0}%</p>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <p class="text-sm text-gray-400">Avg. Resolution Time</p>
                        <p class="text-3xl font-extrabold text-purple-400">${stats.avgResolutionTime}</p>
                    </div>
                     <div class="glass p-4 rounded-xl">
                        <p class="text-sm text-gray-400">AI Sentiment High</p>
                        <p class="text-3xl font-extrabold text-red-400">${stats.counts.urgency['Critical'] || 0}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass p-4 rounded-xl">
                        <h3 class="text-xl font-semibold mb-3 text-cyan-300">Case Type Distribution</h3>
                        <canvas id="caseTypeChart"></canvas>
                    </div>
                    <div class="glass p-4 rounded-xl">
                        <h3 class="text-xl font-semibold mb-3 text-cyan-300">Case Urgency Breakdown</h3>
                        <canvas id="urgencyChart"></canvas>
                    </div>
                </div>
            `;
            
            // Render Charts
            const chartColors = ['#6a0dad', '#00bcd4', '#f59e0b', '#ef4444', '#10b981', '#3b82f6', '#f472b6'];

            new Chart(document.getElementById('caseTypeChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.counts.type),
                    datasets: [{
                        data: Object.values(stats.counts.type),
                        backgroundColor: chartColors.slice(0, Object.keys(stats.counts.type).length),
                        // FIX: Changed invalid 'var(--background-color)' to the string literal '#0D0D2B'
                        borderColor: '#0D0D2B', 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { labels: { color: 'white' } } }
                }
            });

            new Chart(document.getElementById('urgencyChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.counts.urgency),
                    datasets: [{
                        label: 'Incidents by Urgency',
                        data: Object.values(stats.counts.urgency),
                        backgroundColor: ['#ef4444', '#f97316', '#facc15', '#a78bfa'],
                        borderColor: '#0D0D2B',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(106, 13, 173, 0.3)' } },
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(106, 13, 173, 0.3)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        const renderAuditTrail = (container) => {
            container.innerHTML = `
                <h2 class="text-3xl font-bold mb-6 text-cyan-400 border-b border-purple-500/50 pb-2">Blockchain Audit Trail Verification</h2>
                <p class="text-gray-400 mb-6">All changes are chronologically logged and secured by cryptographic hashing. Total Blocks: ${window.COMPLAINTS_DATA.reduce((acc, c) => acc + c.auditLog.length, 0)}</p>
                <div id="audit-log-container" class="space-y-6 timeline overflow-y-auto max-h-[70vh] p-4">
            `;

            const auditLogContainer = document.getElementById('audit-log-container');
            const allLogs = window.COMPLAINTS_DATA.flatMap(c => c.auditLog.map(log => ({ ...log, caseId: c.caseId }))).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            allLogs.forEach(log => {
                const isValid = log.previousHash === '0' || log.hash.startsWith('f'); // Mock verification check (in a real system, you'd check next block)
                const statusColor = log.action.includes('CHANGE') ? 'text-yellow-400' : (log.action.includes('CREATE') ? 'text-green-400' : 'text-cyan-400');
                
                // Simplified display of verification status
                let verificationIcon = '<span title="Block integrity verified" class="text-green-500">✅</span>';
                if (log.action.includes('ERROR')) {
                     verificationIcon = '<span title="Block contains an error" class="text-red-500">❌</span>';
                }

                auditLogContainer.innerHTML += `
                    <div class="timeline-item pb-4">
                        <div class="p-3 glass rounded-xl ml-4">
                            <p class="font-bold ${statusColor} text-lg mb-1">${verificationIcon} Case ${log.caseId}: ${log.action.replace(/_/g, ' ')}</p>
                            <p class="text-xs text-gray-400 mb-2">Timestamp: ${new Date(log.timestamp).toLocaleString()}</p>
                            <div class="text-xs font-mono break-all space-y-1">
                                <p class="text-purple-300">BLOCK HASH: ${log.hash}</p>
                                <p class="text-gray-500">Prev. HASH: ${log.previousHash}</p>
                                <p class="text-gray-500">Data HASH: ${log.dataHash}</p>
                            </div>
                            <p class="text-xs mt-2 text-yellow-500">System User: ${log.userId.substring(0, 8)}...</p>
                        </div>
                    </div>
                `;
            });

            container.innerHTML += `</div>`;
        };

        window.viewCase = (docId) => {
            const caseData = window.COMPLAINTS_DATA.find(c => c.id === docId);
            if (!caseData) {
                window.showTemporaryMessage("Case data not found in local cache.", 'error');
                return;
            }

            const statusColor = caseData.status === 'Resolved' || caseData.status === 'Closed' ? 'bg-green-600/50' : (caseData.status === 'Filed' ? 'bg-yellow-600/50' : 'bg-blue-600/50');
            const urgencyColor = caseData.ai.urgency === 'Critical' ? 'text-red-400' : (caseData.ai.urgency === 'High' ? 'text-orange-400' : 'text-yellow-400');
            const anonBadge = caseData.isAnonymous ? '<span class="text-xs px-2 py-0.5 rounded-full bg-red-900/50 text-red-300 ml-2">ANONYMOUS</span>' : '';

            const content = `
                <div class="space-y-4 text-sm">
                    <p class="text-xl font-bold text-cyan-300">Case ID: ${caseData.caseId} ${anonBadge}</p>
                    <div class="grid grid-cols-2 gap-4 border-b border-purple-500/50 pb-4">
                        <div>
                            <p class="text-gray-400">Status:</p>
                            <p class="font-semibold px-2 py-0.5 rounded-full inline-block ${statusColor}">${caseData.status}</p>
                        </div>
                        <div>
                            <p class="text-gray-400">AI Urgency:</p>
                            <p class="font-semibold ${urgencyColor}">${caseData.ai.urgency}</p>
                        </div>
                        <div>
                            <p class="text-gray-400">Category (AI):</p>
                            <p class="font-semibold text-purple-300">${caseData.ai.category}</p>
                        </div>
                        <div>
                            <p class="text-gray-400">Filer ID:</p>
                            <p class="font-mono text-xs text-yellow-400">${caseData.reportingUserId.substring(0, 8)}...</p>
                        </div>
                    </div>
                    
                    <div class="glass p-3 rounded-lg border border-cyan-400/30">
                        <p class="text-gray-300 font-semibold mb-1">Narrative Summary (AI):</p>
                        <p class="text-white italic">${caseData.ai.summary}</p>
                    </div>

                    <div class="p-3 bg-gray-900/50 rounded-lg">
                        <p class="text-gray-300 font-semibold mb-1">Full Incident Narrative:</p>
                        <p class="text-gray-200 whitespace-pre-wrap">${caseData.narrative}</p>
                    </div>

                    <div class="p-3 bg-gray-900/50 rounded-lg">
                        <p class="text-gray-300 font-semibold mb-1">XAI Justification:</p>
                        <p class="text-gray-500 text-xs">${caseData.ai.xai_justification}</p>
                    </div>

                    <p class="text-right text-xs text-gray-500">Last Updated: ${new Date(caseData.updatedAt).toLocaleDateString()}</p>
                </div>
            `;
            window.openModal(content, `Case File: ${caseData.caseId}`);
        };


        // --- CHATBOT IMPLEMENTATION ---

        window.toggleChatbot = () => {
            window.isChatbotOpen = !window.isChatbotOpen;
            const chatWindow = document.getElementById('chatbot-window');
            if (window.isChatbotOpen) {
                chatWindow.classList.remove('hidden');
                renderChatMessages();
            } else {
                chatWindow.classList.add('hidden');
            }
        };

        const renderChatMessages = () => {
            const messageContainer = document.getElementById('chatbot-messages');
            messageContainer.innerHTML = '';
            
            window.CHATBOT_HISTORY.forEach(msg => {
                const isUser = msg.role === 'user';
                const alignment = isUser ? 'justify-end' : 'justify-start';
                const bubbleClass = isUser ? 'bg-purple-600/50 shadow-purple-400/20' : 'bg-cyan-600/30 shadow-cyan-400/20';
                const text = msg.parts?.[0]?.text || '...';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${alignment}`;
                messageDiv.innerHTML = `
                    <div class="p-2 rounded-lg max-w-[80%] shadow-md ${bubbleClass}">
                        <p class="text-sm text-white">${text}</p>
                    </div>
                `;
                messageContainer.appendChild(messageDiv);
            });
            messageContainer.scrollTop = messageContainer.scrollHeight; // Auto-scroll to bottom
        };

        window.sendChatMessage = async () => {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            // Temporarily disable input/send button while waiting for AI
            input.disabled = true;
            document.querySelector('#chatbot-window button:last-child').disabled = true;

            await window.processChatMessage(message);

            input.disabled = false;
            document.querySelector('#chatbot-window button:last-child').disabled = false;
            input.focus();
        };

        window.processChatMessage = async (message) => {
            window.showTemporaryMessage("Barangay Bot is processing the request...", 'info');

            // Add user message to history
            window.CHATBOT_HISTORY.push({ role: "user", parts: [{ text: message }] });
            renderChatMessages();
            
            // Prepare chat history for API payload
            const chatHistoryForApi = window.CHATBOT_HISTORY.map(msg => ({
                role: msg.role === 'model' ? 'model' : 'user', // Ensure roles are correctly mapped
                parts: msg.parts
            }));

            const systemPrompt = "You are Barangay Bot, an empathetic and highly secure AI assistant for the eBlotter system. You answer questions related to local procedures, give information on case statuses (if the user provides a case ID), and help draft initial complaint narratives. Keep your responses concise and helpful, using a mix of English and Tagalog when appropriate. If the user asks for a case status, check if their message contains a number that looks like a Case ID (e.g., 1000, 1001, etc.). If so, mention that you'd check the system but then state the status is 'In Progress' or 'Resolved' based on your analysis of the request.";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            const payload = {
                contents: chatHistoryForApi,
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I encountered a firewall block. Please try again.";

                // Add AI response to history
                window.CHATBOT_HISTORY.push({ role: "model", parts: [{ text: aiResponseText }] });
                renderChatMessages();
                window.showTemporaryMessage("AI Response Received.", 'success');


            } catch (error) {
                console.error("Chatbot API Error:", error);
                const errorMessage = "System Error: Failed to establish a quantum connection to the AI core. Try again later.";
                window.CHATBOT_HISTORY.push({ role: "model", parts: [{ text: errorMessage }] });
                renderChatMessages();
                window.showTemporaryMessage("Chatbot connection failed.", 'error');
            }
        };


        // --- INITIALIZATION START ---
        window.onload = window.initFirebase;

    </script>
</body>
</html>
